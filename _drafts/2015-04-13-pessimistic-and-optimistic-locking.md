---
# MUST HAVE BEG
layout: post
disqus_identifier: 20150413-pessimistic-and-optimistic-locking # DO NOT CHANGE THE VALUE ONCE SET
title: æ•°æ®åº“ä¸­çš„ä¹è§‚é”å’Œæ‚²è§‚é”
# MUST HAVE END

is_short: true
subtitle:
tags: 
- database
- JPA
date: 2015-04-13 19:13:00
image:
image_desc:
---

ğŸ˜ŠğŸ˜„â¤ï¸ğŸ‘ªğŸ’¯

Emojiæ˜¯unicodeçš„ä¸€éƒ¨åˆ†ï¼ŒUTF-8ç¼–ç ä¹Ÿæ˜¯å¯ä»¥è¡¨ç¤ºEmojiçš„ã€‚
æ¯”å¦‚ğŸ˜å¯¹åº”çš„unicodeæ˜¯`U+1F601`ï¼Œå¯¹åº”çš„UTF-8ç¼–ç æ˜¯`\xF0\x9F\x98\x81`ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨UTF-8ç¼–ç å­˜å‚¨çš„
æ–‡æœ¬ä¸­ï¼ˆæ¯”å¦‚HTMLæ–‡ä»¶ï¼‰ä¿å­˜Emojiè¡¨æƒ…ã€‚

###æ˜¾ç¤ºæ–‡æœ¬ä¸­çš„Emoji
æˆ‘ä»¬éœ€è¦ä¸€ç§å­—ä½“æ¥æ˜¾ç¤ºä»¥UTF-8ç¼–ç çš„Emojiè¡¨æƒ…ã€‚é€šå¸¸ï¼Œä¸€ç§å­—ä½“ä¸èƒ½æ˜¾ç¤ºæ‰€æœ‰çš„UTF-8ç¼–ç ã€‚ä¸èƒ½æ˜¾ç¤ºæ—¶ï¼Œé€šå¸¸
ä¼šæ˜¾ç¤ºæˆä¸€ä¸ªâ€œå°æ–¹å—â€ã€‚åœ¨è¾ƒæ–°çš„OS Xç³»ç»Ÿä¸Šï¼Œ`Apple Color Emoji`å­—ä½“å¯ä»¥æ˜¾ç¤ºEmojiè¡¨æƒ…ã€‚åœ¨è¾ƒæ–°çš„Windowsä¸Š
ï¼ˆæ¯”å¦‚Windows 7/8ï¼‰ï¼Œ`Segoe UI Symbol`å­—ä½“å¯ä»¥æ˜¾ç¤ºé»‘ç™½çš„Emojiè¡¨æƒ…ã€‚Windows 8ä¸Šå¯ä»¥ç”¨
`Segoe UI Emoji`å­—ä½“æ¥æ˜¾ç¤ºå½©è‰²çš„è¡¨æƒ…ã€‚

###æ˜¾ç¤ºç½‘é¡µä¸Šçš„Emoji
å¯¹äºç½‘é¡µå…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡CSSå±æ€§`font-family`æ¥æŒ‡å®šï¼ˆä¸€ç³»åˆ—ï¼‰å­—ä½“ã€‚æ¯”å¦‚ï¼Œ

    font-family: Gill Sans Extrabold, sans-serif;

æ’åœ¨å‰é¢çš„å­—ä½“ä¼˜å…ˆçº§è¾ƒåé¢çš„é«˜ã€‚å¦‚æœç”¨æˆ·ç”µè„‘ä¸Šæ²¡æœ‰å®‰è£…ä¼˜å…ˆçº§é«˜çš„å­—ä½“ï¼Œé‚£ä¹ˆæ ¹æ®ä¼˜å…ˆçº§ä¾æ¬¡å°è¯•åç»­çš„
å­—ä½“ã€‚å¦‚æœæ‰€æœ‰çš„å­—ä½“éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œé‚£ä¹ˆä½¿ç”¨æµè§ˆå™¨æä¾›çš„å­—ä½“ï¼ˆInitial value depends on user agentï¼‰ã€‚
åœ¨OS Xä¸Šï¼Œå¦‚æœfont-familyä¸­æ²¡æœ‰æŒ‡å®šå¯ä»¥æ˜¾ç¤ºEmojiçš„å­—ä½“ï¼ŒSafariæ˜¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºEmojiçš„ï¼Œè€ŒChromeåˆ™ä¸èƒ½ã€‚
è¿™æ˜¯å› ä¸ºè¿™ä¸¤ä¸ªæµè§ˆå™¨æä¾›çš„é»˜è®¤å­—ä½“æœ‰åŒºåˆ«ã€‚

ä¸ºäº†åœ¨Windowså’ŒOS Xä¸Šéƒ½èƒ½æ˜¾ç¤ºEmojiè¡¨æƒ…ï¼Œå¯ä»¥å‘font-familyé‡ŒåŠ å…¥`Apple Color Emoji`ï¼Œ`Segoe UI Emoji`ï¼Œ
å’Œ`Segoe UI Symbol`å­—ä½“ã€‚æ¯”å¦‚ï¼Œ

    font-family: Helvetica, arial, freesans, clean, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol';

æœ€åæ•ˆæœå¦‚ä¸‹ï¼Œ       
Chrome on Windows 7       
<img src="../images/blog/chrome-win7-emoji.png" alt="chrome win7 emoji" title="chrome win7 emoji" style="display: block; width: 90px; margin-left: 0px; margin-right: 0px;">
IE 11 on Windows 7      
<img src="../images/blog/ie-win7-emoji.png" alt="ie win7 emoji" title="ie win7 emoji" style="display: block; width: 90px; margin-left: 0px; margin-right: 0px;">
Safari on OS X     
<img src="../images/blog/safari-osx-emoji-png.png" alt="safari osx emoji" title="safari osx emoji" style="display: block; width: 90px; margin-left: 0px; margin-right: 0px;">
Chrome on OS X      
<img src="../images/blog/chrome-osx-emoji-png.png" alt="chrome osx emoji" title="chrome osx emoji" style="display: block; width: 90px; margin-left: 0px; margin-right: 0px;">


###å‚è€ƒè¿æ¥
[Emoji Unicode Tables](http://apps.timwhitlock.info/emoji/tables/unicode)     
[Segoe UI Symbol](https://msdn.microsoft.com/en-us/library/windows/apps/jj841126.aspx)     
[font-family MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/font-family)      
[font-family](http://www.w3schools.com/cssref/pr_font_font-family.asp)    








æ•°æ®åº“çš„é”/åŠ é”ç­–ç•¥ï¼ˆlock/locking)å’Œæ•°æ®åº“çš„éš”ç¦»çº§åˆ«ï¼ˆisolation levelï¼‰ä¸æ˜¯åŒä¸€ä¸ª
æ¦‚å¿µï¼ˆè™½ç„¶æœ‰å…³è”ï¼‰ã€‚éš”ç¦»çº§åˆ«ä¸»è¦å…³å¿ƒçš„æ˜¯ä¸€ä¸ªtransactionå¯¹å…¶å®ƒtransactionä¿®æ”¹çš„å¯è§æ€§ã€‚
é”/åŠ é”ç­–ç•¥ä¸»è¦å…³å¿ƒå¦‚ä½•æ§åˆ¶å¤šä¸ªtransactionå¯¹è¡¨ä¸ŠæŸä¸€è¡Œï¼ˆrowï¼‰çš„å¹¶å‘è®¿é—®ã€‚

### åŠ é”ç­–ç•¥ Locking
æ•°æ®åº“æœ‰ä¸¤ç§åŠ é”çš„ç­–ç•¥ï¼Œoptimistic lockingä»¥åŠpessimistic lockingã€‚å®ƒä»¬ä¹Ÿç»å¸¸è¢«
ç¿»è¯‘æˆæˆ–è€…å«æˆâ€œä¹è§‚é”â€å’Œâ€œæ‚²è§‚é”â€ã€‚å®é™…ä¸Šï¼Œä¸æ˜¯è¯´ä¸€ä¸ªé”æœ‰â€ä¹è§‚â€œå’Œâ€æ‚²è§‚â€œä¹‹åˆ†ï¼›è€Œæ˜¯è¯´åœ¨ä½¿ç”¨
é”çš„â€æ€åº¦â€œä¸Šæœ‰â€ä¹è§‚â€œå’Œâ€æ‚²è§‚â€œä¹‹åˆ†ã€‚ä¸‹é¢å¯ä»¥çœ‹åˆ°optimistic lockingæ ¹æœ¬ä¸ä¼šä½¿ç”¨é”ã€‚

#### æ‚²è§‚çš„åŠ é”ç­–ç•¥ Pessimistic Locking
é€šè¿‡ä½¿ç”¨é”ï¼ˆä¸åŒç±»å‹çš„é”ï¼‰æ¥é˜²æ­¢æ•°æ®ï¼ˆrowï¼‰è¢«å…¶å®ƒçš„ç”¨æˆ·ä¿®æ”¹ã€‚ç”¨æˆ·Aåœ¨æ‰§è¡Œæ“ä½œï¼ˆæ¯”å¦‚è¯»æˆ–è€…
æ›´æ–°æ“ä½œï¼‰å‰åŠ ä¸Šé”ï¼Œå¦‚æœå…¶å®ƒç”¨æˆ·å¯¹æ•°æ®çš„æ“ä½œå’Œé”æœ‰å†²çªï¼Œé‚£ä¹ˆåœ¨ç”¨æˆ·Aé‡Šæ”¾é”ä¹‹å‰ï¼Œå…¶å®ƒç”¨æˆ·çš„è¿™äº›
æ“ä½œå°†ä¸èƒ½æ‰§è¡Œã€‚

å› ä¸ºç”¨æˆ·åœ¨æ‰§è¡Œæ“ä½œå‰ä¸ç®¡æœªæ¥æ˜¯å¦ä¼šæœ‰å†²çªæ€»æ˜¯åŠ é”ï¼Œæ‰€ä»¥å«pessimistic lockingã€‚è¿™ç§åŠ é”
ç­–ç•¥é€‚ç”¨äºæ•°æ®ç«äº‰ï¼ˆdata contentionï¼‰å‘ç”Ÿçš„æ¦‚ç‡å¾ˆé«˜çš„æƒ…æ™¯ã€‚å› ä¸ºåœ¨è¿™ç§æƒ…æ™¯ä¸‹ï¼Œå¦‚æœé‡‡ç”¨
ä¹è§‚çš„åŠ é”ç­–ç•¥ï¼Œtransactionçš„å›æ»šæ¦‚ç‡é«˜ï¼Œä½¿å¾—å›æ»šçš„æ€»å¼€é”€æ¯”åŠ é”å¸¦æ¥çš„å¼€é”€è¿˜å¤§ã€‚

#### ä¹è§‚çš„åŠ é”ç­–ç•¥ Optimistic Locking
é‡‡ç”¨optimistic lockingæ—¶ï¼Œç”¨æˆ·åœ¨è¯»æ•°æ®æ—¶ä¸ä¼šä½¿ç”¨é”ã€‚å½“ç”¨æˆ·Aæ›´æ–°æ•°æ®æ—¶ï¼Œæ•°æ®åº“ä¼šæ£€æŸ¥å…¶å®ƒ
ç”¨æˆ·æœ‰æ²¡æœ‰ä¿®æ”¹è¿‡è¿™ä»½æ•°æ®ï¼ˆæ¯”å¦‚é€šè¿‡å¯¹æ¯”å†…å­˜ä¸­ç”¨æˆ·Açš„æ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯å’Œæ›´æ–°æ—¶æ•°æ®åº“ä¸­çš„ç‰ˆæœ¬
ä¿¡æ¯ï¼‰ã€‚å¦‚æœç”¨æˆ·Aè¦æ›´æ–°çš„æ•°æ®å·²ç»è¢«å…¶å®ƒç”¨æˆ·æ›´æ–°è¿‡ï¼Œæ•°æ®åº“ä¼šæŠ¥é”™ã€‚é€šå¸¸ç”¨æˆ·æ”¶åˆ°é”™è¯¯æ¶ˆæ¯åä¼š
å›æ»šå¹¶é‡è¯•ã€‚

ä¸ºä»€ä¹ˆæ˜¯ä¹è§‚çš„ï¼Ÿå› ä¸ºé‡‡ç”¨è¿™ç§ç­–ç•¥æ—¶ï¼Œç”¨æˆ·å€¾å‘äºè®¤ä¸ºæ•°æ®ä¹‹é—´æ˜¯æ²¡æœ‰ç«äº‰çš„ã€‚è¿™ç§ç­–ç•¥é€‚ç”¨äºæ•°æ®
ç«äº‰å¾ˆå°‘çš„åœºæ™¯ã€‚è¿™ç§åœºæ™¯ä¸‹ï¼Œå¶å°”çš„å›æ»šå¸¦æ¥çš„å¼€é”€è¦ä½äºåŠ é”é˜²æ­¢å†²çªçš„å¼€é”€ã€‚

### ä¸åŒçš„é”


--------------------

å…·ä½“é”çš„åº”ç”¨è¦å‚è€ƒå…·ä½“çš„db
ä¸æ˜¯â€œä¹è§‚â€ä¹è§‚çš„é”ï¼Œè€Œæ˜¯ä¹è§‚çš„åŠ é”ç­–ç•¥ï¼›

https://technet.microsoft.com/en-us/library/ms189132(v=sql.105).aspx

dbæœ‰ä¸¤ç§å¹¶å‘æ§åˆ¶ï¼ˆconcurrency controlï¼‰ç­–ç•¥ã€‚æ§åˆ¶å¯¹åŒä¸€ä¸ªdatabase objectçš„ä¿®æ”¹ã€‚
æ‚²è§‚çš„åŠ é”ï¼ˆpessimistic lockingï¼‰
ä¸€ä¸ªç”¨æˆ·Aåœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šæ‰§è¡ŒæŸäº›åŠ¨ä½œæ—¶ï¼ˆæ¯”å¦‚æ›´æ–°ï¼Œè¯»ï¼‰ä¼šè¢«åŠ ä¸Šé”ï¼Œå…¶å®ƒç”¨æˆ·ä¹Ÿå¯¹è¿™ä¸ªå¯¹è±¡æ‰§è¡ŒåŠ¨ä½œï¼Œå¦‚æœ
è¿™äº›åŠ¨ä½œå’Œç”¨æˆ·Açš„é”å‘ç”Ÿå†²çªï¼Œé‚£ä¹ˆå°±ä¸èƒ½æ‰§è¡Œè¿™äº›åŠ¨ä½œï¼›
ä¸ºä»€ä¹ˆå«æ‚²è§‚ï¼›
å› ä¸ºæ€»æ˜¯æƒ³ç€å…ˆåŠ é”ï¼›
é€‚ç”¨åœºæ™¯ï¼Œé«˜å¹¶å‘ï¼Œå‘ç”Ÿâ€œæ•°æ®ç«äº‰â€çš„å¯èƒ½æ€§é«˜ï¼›å¦‚æœç”¨ä¹è§‚é”ï¼ˆä¸åŠ é”ï¼‰å›æ»šæ¦‚ç‡é«˜ï¼Œå›æ»šå¤ªå¤šè¿˜ä¸å¦‚äº‹å…ˆå…ˆåŠ é”ï¼Œ
æ˜¯çš„æ“ä½œä¸²è¡ŒåŒ–
A system of locks prevents users from modifying data in a way that affects other users. After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it. This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.



ä¹è§‚çš„åŠ é”ï¼ˆoptimistic lockingï¼‰
In optimistic concurrency control, users do not lock data when they read it. When a user updates data, the system checks to see if another user changed the data after it was read. If another user updated the data, an error is raised. Typically, the user receiving the error rolls back the transaction and starts over. This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.
è¯»æ•°æ®ï¼Œæ—¶é—´ç‚¹tAï¼Œçš„æ—¶å€™ä¸åŠ é”ï¼›æ›´æ–°çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°å…¶ä»–ç”¨æˆ·å·²ç»åœ¨æ—¶é—´ç‚¹tAä¹‹åå·²ç»ä¿®æ”¹äº†æ•°æ®ï¼Œé‚£ä¹ˆæ›´æ–°å¤±è´¥ï¼›
ä¸€èˆ¬æ¥è¯´ï¼Œå›æ»šåä¼šé‡è¯•ï¼›
ä¸ºä»€ä¹ˆä¹è§‚
å› ä¸ºè®¤ä¸ºæ²¡ä»€ä¹ˆç«äº‰ï¼Œä¸éœ€è¦åŠ é”ï¼ŒæˆåŠŸçš„å¯èƒ½æ€§å¤§
é€‚ç”¨åœºæ™¯ï¼Œä½ç«äº‰ï¼Œrollbackï¼ˆå¹¶é‡è¯•ï¼‰çš„ä»£ä»·æ¯”æ¯ä¸ªéƒ½åŠ é”è¦å°ï¼›


https://technet.microsoft.com/en-us/library/ms175519(v=sql.105).aspx
Applies to: SQL Server 2008 R2 and higher versions.

Shared (S) locks
Used for read operations that do not change or update data, such as a SELECT statement.
å…è®¸å¤šä¸ªtransactionåŒæ—¶è¯»SELECTï¼›æ˜¯æ‚²è§‚åŠ é”ç­–ç•¥ä¸‹çš„ä¸€ç§é”ï¼›
å½“resourceä¸Šå­˜åœ¨è¿™ç§é”æ—¶ï¼Œä¸å…è®¸å…¶å®ƒtransactionä¿®æ”¹è¿™ä¸ªå¯¹è±¡ã€èµ„æºï¼›
è¯»æ“ä½œå®Œæˆåè¿™ä¸ªé”é©¬ä¸Šå°±é‡Šæ”¾äº†ï¼›é™¤ééš”ç¦»çº§åˆ«æ˜¯repeatable read or higheræˆ–è€…a locking hint is used to retain the shared (S) locks for the duration of the transaction.

Update (U) locks
Used on resources that can be updated. Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.
prevent a common form of deadlock
æ€ä¹ˆå½¢æˆæ­»é”
Only one transaction can obtain an update (U) lock to a resource at a time.
If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.

Exclusive (X) locks
Used for data-modification operations, such as INSERT, UPDATE, or DELETE. Ensures that multiple updates cannot be made to the same resource at the same time.
prevent access to a resource by concurrent transactionsï¼› é˜²æ­¢å¹¶å‘è®¿é—®
With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.æ²¡æœ‰å…¶å®ƒäººå¯ä»¥ä¿®æ”¹æ•°æ®ï¼›è¯»æ“ä½œä¸€èˆ¬ä¹Ÿä¸è¿è¡Œï¼›å‡ºå‘æœ‰NOLOCK hintå’Œread uncommittedéš”ç¦»çº§åˆ«


è¿˜è®²äº†å…¶ä»–çš„é”
schema lockï¼Œ
key range lockï¼ŒKey-range locking prevents phantom reads
By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.


http://www.objectdb.com/java/jpa/persistence/lock
ä¹è§‚é”å’Œæ‚²è§‚é”æ˜¯åº”ç”¨åœ¨database object levelä¸Šçš„ï¼›
time out

JPA 2 supports both optimistic locking and pessimistic locking

Locking is essential to avoid update collisions resulting from simultaneous updates to the same data by two concurrent users. 

Locking in ObjectDB (and in JPA) is always at the database object level, i.e. each database object is locked separately.

Optimistic locking is applied on transaction commit.
An exception is thrown if it is found out that an update is being performed on an old version of a database object, for which another update has already been committed by another transaction.

When using ObjectDB, optimistic locking is enabled by default and fully automatic.

Optimistic locking should be the first choice for most applications, since compared to pessimistic locking it is easier to use and more efficient.

In the rare cases in which update collision must be revealed earlier (before transaction commit) pessimistic locking can be used. 
When using pessimistic locking, database objects are locked during the transaction and lock conflicts, if they happen, are detected earlier.


maintains a version number for every entity object.
In every transaction in which an entity object is modified its version number is automatically increased by one. 
Version numbers are managed internally but can be exposed by defining a version field.
@Entity public class EntityWithVersionField {
     @Version long version;
}

compares the version number of that object in the database to the version number of the in-memory object being updated.

 OptimisticLockException
 
  indicating that the object has been modified by another user (using another EntityManager) since it was retrieved by the current updater.
æ¯ä¸ªçº¿ç¨‹èµ·ä¸€ä¸ªEMï¼Ÿ


PESSIMISTIC_READ - which represents a shared lock.
PESSIMISTIC_WRITE - which represents an exclusive lock.

An entity object can be locked explicitly by the lock method:
em.lock(employee, LockModeType.PESSIMISTIC_WRITE);

A TransactionRequiredException is thrown if there is no active transaction

A LockTimeoutException is thrown if the requested pessimistic lock cannot be granted:
A PESSIMISTIC_READ lock request fails if another user (which is represented by another EntityManager instance) currently holds a PESSIMISTIC_WRITE lock on that database object.
A PESSIMISTIC_WRITE lock request fails if another user currently holds either a PESSIMISTIC_WRITE lock or a PESSIMISTIC_READ lock on that database object.
  

By default, when a pessimistic lock conflict occurs a LockTimeoutException is thrown immediately.

The "javax.persistence.lock.timeout" hint can be set to allow waiting for a pessimistic lock for a specified number of milliseconds.

Pessimistic locks are automatically released at transaction end (using either commit or rollback).

supports also releasing a lock explicitly
em.lock(employee, LockModeType.NONE);

Other Explicit Lock Modes
OPTIMISTIC (formerly READ)
OPTIMISTIC_FORCE_INCREMENT (formerly WRITE)
PESSIMISTIC_FORCE_INCREMENT

Locking during Retrieval

